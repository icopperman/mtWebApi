<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        label { width: 100px; }
        input { width: 100px;   }
    </style>
    <script src="Scripts/jquery-1.10.2.js"></script>
</head>
<body>
    <form id="form1" >
        <div>
            <div style="width:100px;float: left;">date</div>
            <div style="width:100px;float: left;">zip</div>
            <div style="width:100px; float: left;">miles</div>
            <div style="width:100px; float: left;">time </div>
            <div style="width:100px; float: left;">duration</div>
            <div style="width:100px; float: left;">starts with</div>


            <br />
            <input type="text" id="viewdate" name="viewdate"  />
            <input type="text" id="viewzip" name="viewzip"  />
            <input type="text" id="viewmiles" name="viewmiles"  />
            <input type="text" id="viewbegintime" name="viewbegintime"  />
            <input type="text" id="viewendtime" name="viewendtime"  />
            <input type="text" id="titlestartsWith" name="titlestartsWith"  />
            <input type="text" id="timeZone" name="timeZone"  />
            <input type="button" id="btnSubmit" name="btnSubmit"  value="Find Time" />
        </div>
        <div id="themovietimes"  />
        <div id="content">
            <div id="loadingDiv" style="display:none;">
                Loading....<span id="acnt">0</span>
            </div>
        </div>
    </form>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCA2po6hq5ExEWRqQbDH6hI34fJfA9rEVo">
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            //var eltz = $("#timeZone");
            //var elViewDate = $("#viewdate");
            //var elBeginTime = $("#begintime");

            var d = new Date();
            var n = d.getTimezoneOffset();
            var adate = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
            var zip = "10522";
            var miles = "10";
            var theinterval;

            function updateLoadDiv()
            {
                var currsecs = $("#acnt").text();
                var secs = parseInt(currsecs, 10) + 1;
                $("#acnt").text(secs);

            };

            function cbOK(pos)
            {
                var lat = pos.coords.latitude;
                var long = pos.coords.longitude;
                var geo = new google.maps.Geocoder();
                var latlng = new google.maps.LatLng(lat, long);
                geo.geocode(
                    {
                        'latLng': latlng
                       //,locationType: "APPROXIMATE"
                       // ,'key': "AIzaSyCA2po6hq5ExEWRqQbDH6hI34fJfA9rEVo"
                       // ,'result_type': "postal_code"

                    },
                    function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        alert("ok");
                    } else {
                        alert('Geocoder failed due to: ' + status);
                    }
                });
            }

            function cbError(err) 
            {
                var acode = err.code;
            }

            var geoOptions = { enableHighAccuracy: false, timeout: 300000, maximumAge: 300 };
            window.navigator.geolocation.getCurrentPosition(cbOK, cbError, geoOptions);
            
            $("#timeZone").val(n);
            $("#viewdate").val(adate);
            $("#viewbegintime").val(d.getHours());
            $("#viewmiles").val(miles);
            $("#viewzip").val(zip);

            $("#btnSubmit").on("click", function () {

                var o = {
                    viewDate: $("#viewdate").val(),
                    viewZip: $("#viewzip").val(),
                    viewmiles: $("#viewmiles").val(),
                    viewbegintime: $("#viewbegintime").val(),
                    viewendtime: $("#viewendtime").val(),
                    titlestartswith: $("#titlestartsWith").val()
                };

                var oo = JSON.stringify(o);

                $("#thetable").remove();

                $.ajax("http://emptywebapiazure.azurewebsites.net/api/values",
                {
                    type: "GET",
                    contentType: "application/json",
                    dataType: "jsonp",
                    //jsonp: "jsonp",
                    jsonpCallback: "jsonpCallback",
                    data: o,
                    beforeSend: function(){
                        $("#loadingDiv").show();
                        theinterval = setInterval(updateLoadDiv, 1000);
                    },
                    error: function (jqxhr, textstatus, errorthrown) {
                        clearInterval(theinterval);
                        alert(textstatus + "," + errorthrown);
                    },
                    complete: function (jqxhr, textstatus) {
                        clearInterval(theinterval);
                        alert(textstatus);
                    },
                    success: function jsonpCallback(data) {
                        clearInterval(theinterval);
                        $("#loadingDiv").hide();
                        $("#content").append(  "<table id='thetable' rules='all' border='1'>"
                            +"<tr><th>cnt</th><th>time</th><th>rt</th>"
                            +"<th width=400>movie</th><th>theater</th></tr></table>");
                        $.each(data,
                            function (idx, aval) {
                                var arow = "<tr>" 
                                    + "<td>" + idx + "</td>"
                                    + "<td>" + aval.datetime + "</td>"
                                    + "<td>" + aval.runTime + "</td>"
                                    + "<td>" + aval.title + "</td>"
                                    + "<td>" + aval.theTheatre + "</td>"
                                    + "</tr>";
                                $("#thetable").append(arow);

                            });
                    }
                });
            });

        });

    </script> 
</body>
</html>
