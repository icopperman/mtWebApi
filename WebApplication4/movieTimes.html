<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        label { width: 100px; }
        input { width: 100px;   }
    </style>
    <script src="Scripts/jquery-2.1.3.js"></script>
</head>
<body>
    <form id="form1" >
        <div>
            <div style="width:100px;float: left;">date</div>
            <div style="width:100px;float: left;">zip</div>
            <div style="width:100px; float: left;">miles</div>
            <div style="width:100px; float: left;">time </div>
            <div style="width:100px; float: left;">duration</div>
            <div style="width:100px; float: left;">starts with</div>


            <br />
            <input type="text" id="viewdate" name="viewdate"  />
            <input type="text" id="viewzip" name="viewzip"  />
            <input type="text" id="viewmiles" name="viewmiles"  />
            <input type="text" id="viewbegintime" name="viewbegintime"  />
            <input type="text" id="viewendtime" name="viewendtime"  />
            <input type="text" id="titlestartsWith" name="titlestartsWith"  />
            <input type="text" id="timeZone" name="timeZone"  />
            <input type="button" id="btnSubmit" name="btnSubmit"  value="Find Time" />
        </div>
        <div id="themovietimes"  />
        <div id="content">
            <div id="loadingDiv" style="display:none;">
                Loading....<span id="acnt">0</span>
            </div>
        </div>
    </form>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCA2po6hq5ExEWRqQbDH6hI34fJfA9rEVo">
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            //var eltz = $("#timeZone");
            //var elViewDate = $("#viewdate");
            //var elBeginTime = $("#begintime");

            var d = new Date();
            var n = d.getTimezoneOffset();
            var adate = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
            var zip = "";
            var miles = "10";
            var theinterval;
            var lat, lon;

            console.log("ready function, starting geolcation to get lat/lon");

            var geoOptions = { enableHighAccuracy: false, timeout: 300000, maximumAge: 0 };
            window.navigator.geolocation.getCurrentPosition(geoOK, geoError, geoOptions);

            function updateLoadDiv()
            {
                var currsecs = $("#acnt").text();
                var secs = parseInt(currsecs, 10) + 1;
                $("#acnt").text(secs);

            };

            function cbOK1(pos)
            {
                var lat = pos.coords.latitude;
                var long = pos.coords.longitude;
                var geo = new google.maps.Geocoder();
                var xlatlng = new google.maps.LatLng(lat, long);
                geo.geocode(
                    {
                        location: xlatlng
                        //,componentRestrictions: {
                        //    "administrativeArea": ""
                        //    , "locality": ""
                        //}
                       //,locationType: "APPROXIMATE"
                       // ,'key': "AIzaSyCA2po6hq5ExEWRqQbDH6hI34fJfA9rEVo"
                       // ,'result_type': "postal_code"

                    },
                    function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        alert("okkkkkkkk");
                    } else {
                        alert('Geocoderkkkkkk failed due to: ' + status);
                    }
                });
            }

            function geoOK(pos)
            {
                lat = pos.coords.latitude;
                lon = pos.coords.longitude;
                var posLatLon = lat + "," + lon;
                console.log("geolocation complete ok");

                $.ajax("https://maps.googleapis.com/maps/api/geocode/json",
                {
                    
                    type: "GET",
                    //contentType: "application/json",
                    //dataType: "jsonp",
                    //jsonp: "jsonp",
                    //jsonpCallback: "jsonpCallback",
                    data: {
                        key: "AIzaSyCA2po6hq5ExEWRqQbDH6hI34fJfA9rEVo",
                        latlng: posLatLon,
                        result_type: "postal_code"
                    },

                    beforeSend: function () {
                        console.log("geocode api before send ");
                    },
                    error: function (jqxhr, textstatus, errorthrown) {
                        console.log( "geocode api error " + textstatus + "," + errorthrown);
                    },
                    complete: function (jqxhr, textstatus) {
                        console.log("geocode api complete " + textstatus);
                    },
                    success: function (geoResults) {
                    
                        console.log("geocode api success ");

                        $("#timeZone").val(n);
                        $("#viewdate").val(adate);
                        $("#viewbegintime").val(d.getHours());
                        $("#viewmiles").val(miles);

                        if (geoResults.status != "OK") {
                            $("#viewzip").val("");
                            return;
                        }

                        for (var i = 0; i < geoResults.results.length; i++) {
                            
                            var ageoResult = null;
                            
                            for (var j = 0; j < geoResults.results[i].types.length; j++) {

                                if (geoResults.results[i].types[j] == "postal_code") {
                                    ageoResult = geoResults.results[i];
                                    break;
                                } //end for loop over a georesult type array
                            } 

                            if (ageoResult == null) continue;

                            for (var k = 0; k < ageoResult.address_components.length; k++) {

                                var aAddrCompo = null;

                                for (var l = 0; l < ageoResult.address_components[k].types.length; l++) {

                                    if (ageoResult.address_components[k].types[l] == "postal_code") {
                                        aAddrCompo = ageoResult.address_components[k];
                                        break;
                                    }
                                } //end for loop over a georesult type array

                                if (aAddrCompo == null) continue;

                                zip = aAddrCompo.short_name;
                                $("#viewzip").val(zip);

                                break;

                            }

                        } //end for loop over geoResults
                    } //end success func
                });
            }

            function geoError(err) 
            {
                var acode = err.code;
                console.log("geolocate error " + acode);
            }

            $("#btnSubmit").on("click", function () {

                var o = {
                    viewDate: $("#viewdate").val(),
                    viewZip: $("#viewzip").val(),
                    viewmiles: $("#viewmiles").val(),
                    viewbegintime: $("#viewbegintime").val(),
                    viewendtime: $("#viewendtime").val(),
                    titlestartswith: $("#titlestartsWith").val(),
                    viewLat: lat,
                    viewLon: lon

                };

                var oo = JSON.stringify(o);

                $("#thetable").remove();
                
                var mtURL = "http://" + window.location.host + "/api/values";
                //var mtURL = "http://emptywebapiazure.azurewebsites.net/api/values";

                $.ajax(mtURL,
                {
                    type: "GET",
                    contentType: "application/json",
                    dataType: "jsonp",
                    //jsonp: "jsonp",
                    jsonpCallback: "jsonpCallback",
                    data: o,
                    beforeSend: function () {
                        console.log("invoke webapi svc, before send");
                        $("#loadingDiv").show();
                        theintrval = setInterval(updateLoadDiv, 1000);
                    },
                    error: function (jqxhr, textstatus, errorthrown) {
                        console.log("invoked webapi svc, error: " +  textstatus + "," + errorthrown);
                        clearInterval(theinterval);
                        //alert(textstatus + "," + errorthrown);
                    },
                    complete: function (jqxhr, textstatus) {
                        clearInterval(theinterval);
                        console.log("invoked webapi svc, complete: " + textstatus);
                        //alert(textstatus);
                    },
                    success: function jsonpCallback(data) {
                        console.log("invoked webapi svc, success");
                        clearInterval(theinterval);
                        $("#loadingDiv").hide();
                        $("#content").append(  "<table id='thetable' rules='all' border='1'>"
                            +"<tr><th>cnt</th><th>time</th><th>rt</th>"
                            +"<th width=400>movie</th><th>theater</th></tr></table>");
                        $.each(data,
                            function (idx, aval) {
                                var arow = "<tr>" 
                                    + "<td>" + idx + "</td>"
                                    + "<td>" + aval.d + "</td>"
                                    + "<td>" + aval.r + "</td>"
                                    + "<td>" + aval.t + "</td>"
                                    + "<td>" + aval.h + "</td>"
                                    + "</tr>";
                                $("#thetable").append(arow);

                            });
                    }
                });
            });

        });

    </script> 
</body>
</html>
